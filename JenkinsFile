pipeline {
    agent any

    environment {
        // Define the Maven tool installation name
        MAVEN_HOME = tool name: 'Maven', type: 'maven'
        // Credential ID for ReportPortal token
        RP_CREDS = 'rpCreds'
        REPORTPORTAL_URL = 'http://localhost:8080'
        REPORTPORTAL_PROJECT = 'cucumber'
    }

    stages {
        stage('Checkout') {
            steps {
                git url: 'https://github.com/atulsharmacsk/CucumberReportPortal'
            }
        }

        stage('setting up reportportal') {
            steps{
                script {
                    withCredentials([string(credentialsId: env.RP_CREDS, variable: 'token')]){
                            def content = """
                                rp.uuid = ${token}
                                rp.launch = JENKINS_DEMO_${JOB_BASE_NAME}
                                rp.description = ${JOB_URL}${BUILD_NUMBER}
                                rp.attributes = Cucumber:${JOB_BASE_NAME}
                            """.stripIndent()
                            def filePath = "${WORKSPACE}/src/test/resources/reportportal.properties"
                            def existingContent = readFile(filePath).trim()
                            writeFile file: filePath, text: existingContent+content, append:true

                            // Print content of the updated file
                            echo "Updated content of ${filePath}:"
                            echo readFile(filePath)
                    }
                }
            }
        }

        stage('Build') {
            steps {
                // Run Maven commands based on the detected OS
                script {
                    try {
                        bat "\"${MAVEN_HOME}\\bin\\mvn\" clean test"
                    }
                    catch(Exception e) {
                        echo "Build stage failed with error: ${e}"
                        currentBuild.result = 'FAILURE'
                    } 
                }
            }
        }

         stage('rerun failed cases') {
            when {
                expression { currentBuild.result == 'FAILURE' }
            }
             steps {
                 script {
                    //get latest launch id
                     withCredentials([string(credentialsId: env.RP_CREDS, variable: 'token')]){
                     def response = httpRequest(
                     url: "${env.REPORTPORTAL_URL}/api/v1/${env.REPORTPORTAL_PROJECT}/launch?page.page=1&page.size=1&page.sort=startTime,desc",
                        customHeaders: [
                            [
                                name: 'Authorization', 
                                value: "Bearer ${token}", 
                                maskValue: true
                            ]
                        ]
                    )
                    def jsonResponse = readJSON text: response.content
                    def latestLaunchId = jsonResponse.content[0].uuid
                    echo "Latest Launch ID: ${latestLaunchId}"
                    // Store the launch ID for later use
                    env.LATEST_LAUNCH_ID = latestLaunchId
                    }

                 // append reportportal.properties for rerun
                  def content = """
                                    rp.rerun = true
                                    //rp.rerun.of = ${env.LATEST_LAUNCH_ID}
                                """.stripIndent()
                  def filePath = "${WORKSPACE}/src/test/resources/reportportal.properties"
                  def existingContent = readFile(filePath).trim()
                  writeFile file: filePath, text: content+existingContent, append:true
                 // Print content of the updated file
                  echo "Updated content of ${filePath}:"
                  echo readFile(filePath)

                  sleep 3  

                  bat "\"${MAVEN_HOME}\\bin\\mvn\" exec:java@rerun-failed-tests -DpassTest=1"
                 }
             }
         }

    }
}
